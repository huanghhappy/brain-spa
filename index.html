<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>è§£å£“æ²»ç™‚æ‰€ Brain SPA</title>
    <style>
        /* å­—é«”è¨­å®šï¼šä½¿ç”¨ swap ç¢ºä¿ä¸ç™½å± */
        @font-face { font-family: 'GenSenRounded2TW'; src: url('500.otf') format('opentype'); font-weight: 500; font-display: swap; }
        @font-face { font-family: 'GenSenRounded2TW'; src: url('700.otf') format('opentype'); font-weight: 700; font-display: swap; }
        @font-face { font-family: 'GenSenRounded2TW'; src: url('900.otf') format('opentype'); font-weight: 900; font-display: swap; }

        :root {
            --bg-color: #FDF6E3; --primary: #FFB3BA; --secondary: #BAE1FF;
            --text-color: #555555; --card-bg: #FFFFFF;
        }

        * {
            box-sizing: border-box; font-family: 'GenSenRounded2TW', 'Noto Sans TC', sans-serif;
            margin: 0; padding: 0; user-select: none; -webkit-tap-highlight-color: transparent;
        }

        body {
            background-color: var(--bg-color); color: var(--text-color);
            display: flex; flex-direction: column; align-items: center;
            min-height: 100vh; min-height: 100dvh; 
            padding: 2.5vh 15px 1.5vh 15px; justify-content: space-between; overflow: hidden;
        }

        #main-screen-container {
            flex: 1; display: flex; flex-direction: column; align-items: center;
            justify-content: flex-start; padding-top: 1vh; width: 100%; max-width: 500px;
        }

        #main-screen { width: 100%; display: flex; flex-direction: column; align-items: center; }

        h1 { font-size: 24px; font-weight: 900; margin-bottom: 2.5vh; color: #333; text-align: center; }

        .severity-selector {
            background: var(--card-bg); padding: 15px; border-radius: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 3vh; text-align: center; width: 100%;
        }

        .severity-selector p { font-size: 14px; font-weight: 700; margin-bottom: 12px; }

        input[type=range] {
            -webkit-appearance: none; appearance: none; width: 100%; height: 12px; border-radius: 6px;
            background: #eee; outline: none; margin: 10px 0; border: none;
        }
        input[type=range]:focus { outline: none; }
        
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; appearance: none; width: 36px; height: 36px;
            cursor: pointer; background: var(--thumb-img) center/contain no-repeat;
            background-color: transparent; border: none; outline: none; box-shadow: none;
            transform: translateY(-2px);
        }

        .game-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; width: 100%; }

        .game-btn {
            background-color: var(--card-bg); border: none; border-radius: 12px;
            padding: clamp(12px, 2vh, 18px) 5px; font-size: 14px; font-weight: 700;
            color: var(--text-color); cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.05);
            transition: transform 0.1s; display: flex; flex-direction: row;
            align-items: center; justify-content: center; gap: 6px; white-space: nowrap;
        }
        .game-btn:active { transform: scale(0.95); }
        .game-btn .icon { font-size: 18px; }

        footer { margin-top: auto; font-size: 11px; font-weight: 500; color: #aaaaaa; text-align: center; }

        #game-screen {
            display: none; flex: 1; flex-direction: column; align-items: center;
            width: 100%; max-width: 500px; justify-content: center; position: relative;
        }

        .back-btn {
            position: absolute; top: 0; left: 0; background: var(--primary); color: white;
            border: none; padding: 8px 15px; border-radius: 20px; font-size: 14px;
            font-weight: 700; cursor: pointer; box-shadow: 0 4px 10px rgba(255, 179, 186, 0.4); z-index: 10;
        }

        .game-container {
            width: 100%; flex: 1; max-height: 70vh; display: flex; justify-content: center;
            align-items: center; background: var(--card-bg); border-radius: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05); overflow: hidden; position: relative;
            margin-top: 45px; margin-bottom: 20px; flex-direction: column;
        }

        /* --- éŠæˆ²å°ˆå±¬ CSS --- */
        
        /* 1. æ‹¼åœ– */
        .puzzle-board { width: 200px; height: 200px; display: grid; grid-template-columns: 1fr 1fr; grid-template-rows: 1fr 1fr; gap: 2px; background: #eee; border: 4px solid #ddd; border-radius: 10px; margin-bottom: 20px; position: relative; }
        .puzzle-slot { width: 100%; height: 100%; background: #fafafa; border-radius: 4px; }
        .puzzle-piece { width: 96px; height: 96px; position: absolute; border-radius: 4px; background-size: 200px 200px; box-shadow: 0 4px 8px rgba(0,0,0,0.2); transition: transform 0.2s; z-index: 2; cursor: pointer; }
        .puzzle-piece.snapped { box-shadow: none; z-index: 1; pointer-events: none; }

        /* 2. æ³¡æ³¡ç´™ */
        .bubble-wrap { display: grid; grid-template-columns: repeat(6, 1fr); gap: 6px; padding: 10px; }
        .bubble { width: 35px; height: 35px; background: radial-gradient(circle at 30% 30%, #ffffff, #BAE1FF); border-radius: 50%; box-shadow: inset 0 -2px 5px rgba(0,0,0,0.1), 0 2px 5px rgba(0,0,0,0.2); cursor: pointer; }
        .bubble.popped { background: #e0f0ff; box-shadow: inset 0 2px 5px rgba(0,0,0,0.1); transform: scale(0.9); }

        /* 3. é‰›ç­† */
        .pencil-stage { display: flex; align-items: flex-end; gap: 10px; height: 220px; border-bottom: 5px solid #eee; padding-bottom: 10px; }
        .pencil { width: 30px; border-radius: 3px 3px 0 0; position: relative; cursor: pointer; transition: height 0.1s; display: flex; justify-content: center; box-shadow: inset -5px 0 10px rgba(0,0,0,0.1); }
        .pencil::after { content: ''; position: absolute; top: 0; left: 0; width: 0; height: 0; border-left: 15px solid transparent; border-right: 15px solid transparent; border-bottom: 25px solid #FFDFBA; transform: translateY(-100%); z-index: 1;}
        .pencil::before { content: ''; position: absolute; top: -25px; left: 7.5px; width: 0; height: 0; border-left: 7.5px solid transparent; border-right: 7.5px solid transparent; border-bottom: 12px solid var(--pen-color); z-index: 2; }

        /* 4. é¡è‰²æ’åº */
        .color-stage { display: flex; flex-direction: column; gap: 6px; width: 80%; }
        .color-block { height: 35px; border-radius: 10px; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .color-block.selected { transform: scale(0.95); box-shadow: inset 0 4px 6px rgba(0,0,0,0.2); border: 3px solid #333; }

        /* 5. æ“ ç—˜ç—˜ (3D é»åœŸé¢¨) */
        /* å°‡é ­éƒ¨å®¹å™¨åˆ†ç‚º head-wrapper (ä¸å‰ªè£ï¼Œæ”¾è€³æœµ) èˆ‡ face-container (å‰ªè£ï¼Œæ”¾äº”å®˜èˆ‡ç—˜ç—˜) */
        .head-wrapper { width: 240px; height: 260px; position: relative; margin-bottom: 10px; }
        .face-container { 
            width: 100%; height: 100%; border-radius: 50% 50% 45% 45%; 
            box-shadow: inset -15px -20px 40px rgba(0,0,0,0.15), inset 10px 10px 20px rgba(255,255,255,0.4), 0 10px 20px rgba(0,0,0,0.05); 
            position: absolute; top: 0; left: 0; overflow: hidden; transition: background 0.3s; z-index: 2;
        }
        .ear { position: absolute; width: 40px; height: 55px; border-radius: 50%; top: 45%; z-index: 1; transition: background 0.3s; box-shadow: inset -5px -5px 10px rgba(0,0,0,0.1), inset 5px 5px 10px rgba(255,255,255,0.3); }
        .ear.left { left: -15px; transform: rotate(-15deg); }
        .ear.right { right: -15px; transform: rotate(15deg); }
        .face-eyes { position: absolute; top: 42%; width: 100%; display: flex; justify-content: center; gap: 40px; pointer-events: none; }
        .eye { width: 16px; height: 16px; border-radius: 50%; background: radial-gradient(circle at 35% 35%, #555, #111); box-shadow: inset 2px 2px 4px rgba(0,0,0,0.5), 0 2px 4px rgba(255,255,255,0.4); }
        .face-blush { position: absolute; top: 48%; width: 100%; display: flex; justify-content: center; gap: 60px; pointer-events: none; }
        .blush { width: 25px; height: 15px; border-radius: 50%; opacity: 0.6; filter: blur(2px); transition: background 0.3s; }
        .face-nose { position: absolute; top: 52%; left: 50%; transform: translateX(-50%); width: 22px; height: 14px; border-radius: 50%; filter: brightness(0.95); pointer-events: none; box-shadow: -2px 3px 5px rgba(0,0,0,0.15), inset 2px 2px 5px rgba(255,255,255,0.5); transition: background 0.3s; }
        /* é‡æ–°è¨­è¨ˆçš„ç«‹é«”å¯æ„›å°å˜´å·´ */
        .face-mouth { position: absolute; top: 65%; left: 50%; transform: translateX(-50%); width: 14px; height: 18px; background: #6A040F; border-radius: 50px 50px 80px 80px; box-shadow: inset 0 4px 6px rgba(0,0,0,0.4); pointer-events: none; }
        
        .pimple { position: absolute; border-radius: 50%; display: flex; justify-content: center; align-items: center; cursor: pointer; transition: transform 0.1s; z-index: 10; }
        .pimple-core { width: 30%; height: 30%; background: #FFFACD; border-radius: 50%; opacity: 0.9; }

    </style>
</head>
<body>

    <div id="main-screen-container">
        <div id="main-screen">
            <h1>ğŸ§  è§£å£“æ²»ç™‚æ‰€ Brain SPA âœ¨</h1>
            <div class="severity-selector">
                <p>è«‹é¸æ“‡ä½ ç›®å‰çš„å¼·è¿«ç—‡ç™¼ä½œæŒ‡æ•¸</p>
                <input type="range" id="severity-slider" min="0" max="10" value="5">
                <div style="display: flex; justify-content: space-between; font-size: 11px; font-weight: 500; color: #aaa; margin-top: 5px;">
                    <span>å¾®ç„¦æ…®</span><span>å¿«çˆ†ç‚¸</span>
                </div>
            </div>

            <div class="game-grid">
                <button class="game-btn" onclick="startGame('puzzle')"><span class="icon">ğŸ§©</span> ç™‚ç™’æ‹¼åœ–</button>
                <button class="game-btn" onclick="startGame('bubble')"><span class="icon">ğŸ«§</span> æ“ æ³¡æ³¡ç´™</button>
                <button class="game-btn" onclick="startGame('pencil')"><span class="icon">ğŸ–ï¸</span> é‰›ç­†å‰Šå¹³</button>
                <button class="game-btn" onclick="startGame('color')"><span class="icon">ğŸŒˆ</span> é¡è‰²æ’åº</button>
                <button class="game-btn" onclick="startGame('pimple')"><span class="icon">ğŸ’¥</span> æ“ ç—˜ç—˜</button>
                <button class="game-btn" onclick="alert('æº–å‚™è§£é–ä¸­ï¼å…ˆç©ç©å‰é¢äº”å€‹å§ğŸ˜‰')"><span class="icon">ğŸ“¦</span> è²“å’ªæ­¸ä½</button>
                <button class="game-btn" onclick="alert('æº–å‚™è§£é–ä¸­ï¼å…ˆç©ç©å‰é¢äº”å€‹å§ğŸ˜‰')"><span class="icon">ğŸ©¹</span> æ’•é™¤æ¨™ç±¤</button>
                <button class="game-btn" onclick="alert('æº–å‚™è§£é–ä¸­ï¼å…ˆç©ç©å‰é¢äº”å€‹å§ğŸ˜‰')"><span class="icon">ğŸ§¹</span> æ¡Œå¸ƒé™¤å¡µ</button>
                <button class="game-btn" onclick="alert('æº–å‚™è§£é–ä¸­ï¼å…ˆç©ç©å‰é¢äº”å€‹å§ğŸ˜‰')"><span class="icon">ğŸª†</span> ä¿„ç¾…æ–¯å¥—å¨ƒ</button>
                <button class="game-btn" onclick="alert('æº–å‚™è§£é–ä¸­ï¼å…ˆç©ç©å‰é¢äº”å€‹å§ğŸ˜‰')"><span class="icon">ğŸ“„</span> ç¢ç´™æ©Ÿ</button>
            </div>
        </div>
    </div>

    <div id="game-screen">
        <button class="back-btn" onclick="showMainScreen()">ğŸ”™ è¿”å›æ²»ç™‚æ‰€</button>
        <div class="game-container" id="game-content"></div>
    </div>

    <footer>Â© 2026 an App a Day Project.</footer>

    <script>
        // ==========================================
        // ã€ç©¶æ¥µç‰ˆç„¡å»¶é²éŸ³æ•ˆã€‘Web Audio API æ ¸å¿ƒé‚è¼¯
        // ç›´æ¥å°‡éŸ³æ•ˆæª”è§£ç¢¼è‡³è¨˜æ†¶é«”ï¼Œå¯¦ç¾çœŸæ­£çš„ 0 æ¯«ç§’å»¶é²èˆ‡ç„¡é™é‡ç–Šæ’­æ”¾
        // ==========================================
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        let audioCtx;
        const audioBuffers = {};

        // éåŒæ­¥è¼‰å…¥èˆ‡è§£ç¢¼éŸ³æ•ˆ
        async function loadAudio(name, url) {
            try {
                const response = await fetch(url);
                const arrayBuffer = await response.arrayBuffer();
                const audioBuffer = await audioCtx.decodeAudioData(arrayBuffer);
                audioBuffers[name] = audioBuffer;
            } catch (e) {
                console.log(`éŸ³æ•ˆ ${name} è¼‰å…¥å¤±æ•—æˆ–æœªæ‰¾åˆ°æª”æ¡ˆ`, e);
            }
        }

        // å¿…é ˆåœ¨ä½¿ç”¨è€…ã€Œç¬¬ä¸€æ¬¡é»æ“ŠæŒ‰éˆ•æ™‚ã€åˆå§‹åŒ–ï¼Œç¬¦åˆç€è¦½å™¨å®‰å…¨è¦ç¯„
        function initAudio() {
            if (!audioCtx) {
                audioCtx = new AudioContext();
                loadAudio('pop', 'pop.mp3');
                loadAudio('shave', 'shave.mp3');
                loadAudio('pimple', 'pimple.mp3');
            }
            if (audioCtx.state === 'suspended') {
                audioCtx.resume();
            }
        }

        // å‘¼å«æ’­æ”¾éŸ³æ•ˆï¼šå»ºç«‹æ–°çš„ Source Nodeï¼Œç™¼è²å¾Œè‡ªå‹•å›æ”¶
        function playSound(name) {
            if (!audioCtx || !audioBuffers[name]) return;
            const source = audioCtx.createBufferSource();
            source.buffer = audioBuffers[name];
            source.connect(audioCtx.destination);
            source.start(0);
        }

        // ==========================================
        // UI èˆ‡è·¯ç”±é‚è¼¯
        // ==========================================
        const mainScreenContainer = document.getElementById('main-screen-container');
        const gameScreen = document.getElementById('game-screen');
        const gameContent = document.getElementById('game-content');
        const footer = document.querySelector('footer');
        
        const emojis = ['ğŸ«£', 'ğŸ˜–', 'ğŸ«¨', 'ğŸ˜µâ€ğŸ’«', 'ğŸ« ', 'ğŸ¥¶', 'ğŸ¤¢', 'ğŸ¤®', 'ğŸ˜µ', 'ğŸ¤¯', 'ğŸ’¥'];
        const slider = document.getElementById('severity-slider');

        function updateSliderEmoji() {
            const currentEmoji = emojis[parseInt(slider.value)];
            const svg = `<svg xmlns="http://www.w3.org/2000/svg" width="40" height="40"><text x="50%" y="50%" dominant-baseline="central" text-anchor="middle" font-size="30">${currentEmoji}</text></svg>`;
            slider.style.setProperty('--thumb-img', `url('data:image/svg+xml;utf8,${encodeURIComponent(svg)}')`);
        }
        slider.addEventListener('input', updateSliderEmoji);
        updateSliderEmoji();

        function startGame(gameId) {
            initAudio(); // ç¢ºä¿ Web Audio API å•Ÿå‹•
            mainScreenContainer.style.display = 'none';
            gameScreen.style.display = 'flex'; footer.style.display = 'none';
            gameContent.innerHTML = ''; 
            
            if (gameId === 'puzzle') initPuzzleGame();
            if (gameId === 'bubble') initBubbleGame();
            if (gameId === 'pencil') initPencilGame();
            if (gameId === 'color') initColorGame();
            if (gameId === 'pimple') initPimpleGame();
        }

        function showMainScreen() {
            gameScreen.style.display = 'none';
            mainScreenContainer.style.display = 'flex'; footer.style.display = 'block';
        }

        // --- 1. ç™‚ç™’æ‹¼åœ– ---
        const puzzlePatterns = [
            'linear-gradient(135deg, #FFB3BA, #BAE1FF)', 'linear-gradient(135deg, #FFDFBA, #FFFFBA)',
            'linear-gradient(135deg, #BAFFC9, #BAE1FF)', 'linear-gradient(135deg, #E0BBE4, #957DAD)',
            'linear-gradient(135deg, #D291BC, #FEC8D8)', 'linear-gradient(135deg, #FFC3A0, #FFAFBD)',
            'linear-gradient(135deg, #A18CD1, #FBC2EB)', 'linear-gradient(135deg, #84FAB0, #8FD3F4)',
            'linear-gradient(135deg, #FCCB90, #D57EEB)', 'linear-gradient(135deg, #F093FB, #F5576C)'
        ];
        let lastPuzzleIndex = -1;

        window.initPuzzleGame = function() {
            let nextIndex;
            do { nextIndex = Math.floor(Math.random() * puzzlePatterns.length); } 
            while (nextIndex === lastPuzzleIndex);
            lastPuzzleIndex = nextIndex;
            
            let currentPattern = puzzlePatterns[nextIndex];
            
            gameContent.innerHTML = `
                <p style="margin-bottom:15px;font-weight:700;text-align:center;">å–®æ“Šå¯æ—‹è½‰ï¼Œä¸¦æ‹–æ›³åˆ°æ­£ç¢ºä½ç½®</p>
                <div class="puzzle-board" id="p-board">
                    <div class="puzzle-slot" id="slot-0"></div><div class="puzzle-slot" id="slot-1"></div>
                    <div class="puzzle-slot" id="slot-2"></div><div class="puzzle-slot" id="slot-3"></div>
                </div>
                <div id="pieces-container" style="position:relative; width:250px; height:120px;"></div>
                <button onclick="initPuzzleGame()" style="margin-top:10px;padding:10px 20px;border-radius:15px;border:none;background:var(--primary);color:white;font-weight:700;cursor:pointer;">ğŸ”„ å†æ‹¼ä¸€çµ„</button>
            `;
            
            const pBoard = document.getElementById('p-board');
            const pContainer = document.getElementById('pieces-container');
            const positions = ['0 0', '-100px 0', '0 -100px', '-100px -100px'];
            let snappedCount = 0;

            for(let i=0; i<4; i++) {
                let piece = document.createElement('div');
                piece.className = 'puzzle-piece';
                piece.style.backgroundImage = currentPattern;
                piece.style.backgroundPosition = positions[i];
                piece.dataset.id = i;
                
                let startX = Math.random() * 150;
                let startY = Math.random() * 20;
                let rot = Math.floor(Math.random() * 4) * 90;
                piece.dataset.rot = rot;
                piece.style.left = startX + 'px'; piece.style.top = startY + 'px';
                piece.style.transform = `rotate(${rot}deg)`;
                
                pContainer.appendChild(piece);

                let isDragging = false, hasMoved = false, offsetX, offsetY;

                piece.addEventListener('touchstart', e => {
                    isDragging = true; hasMoved = false;
                    let touch = e.touches[0];
                    let rect = piece.getBoundingClientRect();
                    offsetX = touch.clientX - rect.left;
                    offsetY = touch.clientY - rect.top;
                    piece.style.zIndex = 10;
                });

                piece.addEventListener('touchmove', e => {
                    if(!isDragging) return;
                    hasMoved = true;
                    let touch = e.touches[0];
                    piece.style.position = 'fixed';
                    piece.style.left = (touch.clientX - offsetX) + 'px';
                    piece.style.top = (touch.clientY - offsetY) + 'px';
                    e.preventDefault();
                }, {passive: false});

                piece.addEventListener('touchend', e => {
                    isDragging = false; piece.style.zIndex = 2;
                    if(!hasMoved) {
                        rot = (rot + 90) % 360;
                        piece.dataset.rot = rot;
                        piece.style.transform = `rotate(${rot}deg)`;
                        return;
                    }
                    let slot = document.getElementById('slot-' + i);
                    let slotRect = slot.getBoundingClientRect();
                    let pieceRect = piece.getBoundingClientRect();
                    let dx = Math.abs(slotRect.left - pieceRect.left);
                    let dy = Math.abs(slotRect.top - pieceRect.top);

                    if(dx < 30 && dy < 30 && rot === 0) {
                        piece.classList.add('snapped');
                        piece.style.position = 'absolute';
                        piece.style.left = slot.offsetLeft + 'px';
                        piece.style.top = slot.offsetTop + 'px';
                        pBoard.appendChild(piece);
                        snappedCount++;
                        if(snappedCount === 4) setTimeout(() => alert('âœ¨ æ‹¼åœ–å®Œæˆï¼ç•«é¢å¤ªèˆ’æœäº†ï¼'), 300);
                    }
                });
            }
        }

        // --- 2. æ“ æ³¡æ³¡ç´™ (åŠ å…¥æˆåŠŸåˆ¤æ–·) ---
        let poppedBubblesCount = 0;
        window.initBubbleGame = function() {
            poppedBubblesCount = 0;
            let html = `<div class="bubble-wrap">`;
            for(let i=0; i<36; i++) {
                html += `<div class="bubble" onclick="popBubble(this)"></div>`;
            }
            html += `</div>`;
            gameContent.innerHTML = `<p style="margin-bottom:15px;font-weight:700;">ç›¡æƒ…æçˆ†å®ƒå€‘å§ï¼</p>${html}<button onclick="initBubbleGame()" style="margin-top:15px;padding:10px 20px;border-radius:15px;border:none;background:var(--primary);color:white;font-weight:700;cursor:pointer;">ğŸ”„ æ›å¼µæ–°çš„</button>`;
        }

        window.popBubble = function(el) {
            if(!el.classList.contains('popped')) {
                el.classList.add('popped');
                playSound('pop');
                poppedBubblesCount++;
                if(poppedBubblesCount === 36) {
                    setTimeout(() => alert('âœ¨ æ³¡æ³¡å…¨æçˆ†äº†ï¼ç¥æ¸…æ°£çˆ½ï¼'), 300);
                }
            }
        }

        // --- 3. é‰›ç­†å‰Šå¹³ ---
        window.initPencilGame = function() {
            const colors = ['#FF6B6B', '#FFA06B', '#FFD166', '#06D6A0', '#118AB2', '#8338EC'];
            let heights = colors.map(() => Math.floor(Math.random() * 11 + 10) * 10);
            let targetHeight = Math.min(...heights);

            let html = `<p style="margin-bottom:20px;font-weight:700;">é»æ“Šéé•·çš„é‰›ç­†ï¼ŒæŠŠå®ƒå€‘å‰Šé½Šå¹³ï¼</p><div class="pencil-stage">`;
            colors.forEach((c, idx) => {
                html += `<div class="pencil" id="pen-${idx}" style="height:${heights[idx]}px; background:${c}; --pen-color:${c};" onclick="shavePen(${idx})"></div>`;
            });
            html += `</div><button onclick="initPencilGame()" style="margin-top:20px;padding:10px 20px;border-radius:15px;border:none;background:var(--primary);color:white;font-weight:700;cursor:pointer;">ğŸ”„ æ›ä¸€æŠŠç­†</button>`;
            gameContent.innerHTML = html;

            window.shavePen = function(idx) {
                const el = document.getElementById(`pen-${idx}`);
                let h = parseInt(el.style.height);
                if(h > targetHeight) {
                    el.style.height = (h - 10) + 'px';
                    playSound('shave'); 
                }
                checkPencils();
            }

            function checkPencils() {
                let allEqual = true;
                for(let i=0; i<6; i++) {
                    if(parseInt(document.getElementById(`pen-${i}`).style.height) !== targetHeight) {
                        allEqual = false; break;
                    }
                }
                if(allEqual) setTimeout(() => alert('âœ¨ å…¨éƒ¨ä¸€æ¨£å¹³äº†ï¼å¼·è¿«ç—‡æ²»ç™’ï¼'), 300);
            }
        }

        // --- 4. é¡è‰²æ’åº ---
        const palettes = [
            ['#732031', '#A12D45', '#D03958', '#E85B7A', '#EF8A9F', '#F4B3C0', '#F9D9DF', '#FDF1F3'],
            ['#03045E', '#023E8A', '#0077B6', '#0096C7', '#00B4D8', '#48CAE4', '#90E0EF', '#CAF0F8'],
            ['#081C15', '#1B4332', '#2D6A4F', '#40916C', '#52B788', '#74C69D', '#95D5B2', '#B7E4C7'],
            ['#370617', '#6A040F', '#9D0208', '#D00000', '#DC2F02', '#E85D04', '#F48C06', '#FAA307'],
            ['#10002B', '#240046', '#3C096C', '#5A189A', '#7B2CBF', '#9D4EDD', '#C77DFF', '#E0AAFF'],
            ['#38220F', '#463220', '#5E4835', '#7A624E', '#9C826B', '#C0A991', '#E2CFC0', '#F3E8E0'],
            ['#212529', '#343A40', '#495057', '#6C757D', '#ADB5BD', '#CED4DA', '#DEE2E6', '#F8F9FA'],
            ['#00211F', '#00423D', '#00625B', '#00837A', '#00A498', '#20C5B7', '#60D7CD', '#A0E9E3'],
            ['#4D3A00', '#806000', '#B38600', '#E6AC00', '#FFC300', '#FFD033', '#FFDD66', '#FFEA99'],
            ['#2E1E3B', '#4D3263', '#6B468A', '#8A5AB1', '#A972D3', '#BE92E0', '#D3B3ED', '#E8D4F6']
        ];

        window.initColorGame = function() {
            let correctOrder = palettes[Math.floor(Math.random() * palettes.length)];
            let currentOrder = [...correctOrder].sort(() => Math.random() - 0.5); 
            
            window.renderColorBlocks = () => {
                let html = `
                    <div style="text-align:center; margin-bottom:25px;">
                        <p style="font-weight:700; margin-bottom:15px;">é»æ“Šå…©å¡Šé¡è‰²ä¾†äº’ç›¸äº¤æ›ä½ç½®</p>
                        <p style="font-size:13px; color:#888;">è«‹å°‡é¡è‰²ç”±ä¸Šè€Œä¸‹ï¼Œä¾åºå¾ã€Œæœ€æ·±ã€æ’åˆ—åˆ°ã€Œæœ€æ·ºã€</p>
                    </div>
                    <div class="color-stage">`;
                currentOrder.forEach((color, idx) => {
                    html += `<div class="color-block" style="background:${color}" onclick="selectColor(${idx})" id="cb-${idx}"></div>`;
                });
                html += `</div><button onclick="initColorGame()" style="margin-top:20px;padding:10px 20px;border-radius:15px;border:none;background:var(--primary);color:white;font-weight:700;cursor:pointer;">ğŸ”„ æ›ä¸€çµ„é¡è‰²</button>`;
                gameContent.innerHTML = html;
            };
            
            let selectedIdx = -1;
            window.selectColor = function(idx) {
                const block = document.getElementById(`cb-${idx}`);
                if(selectedIdx === -1) {
                    selectedIdx = idx; block.classList.add('selected');
                } else {
                    let temp = currentOrder[selectedIdx];
                    currentOrder[selectedIdx] = currentOrder[idx];
                    currentOrder[idx] = temp;
                    selectedIdx = -1;
                    renderColorBlocks();
                    
                    if(JSON.stringify(currentOrder) === JSON.stringify(correctOrder)) {
                        setTimeout(() => alert('âœ¨ æ¼¸å±¤å¥½å®Œç¾ï¼çœ¼ç›ç™‚ç™’äº†ï¼'), 300);
                    }
                }
            }
            renderColorBlocks();
        }

        // --- 5. æ“ ç—˜ç—˜ (3D é»åœŸé¢¨å‡ç´šç‰ˆ) ---
        const faceConfigs = [
            { bg: '#FFF5E1', blush: '#FFD1D1' }, { bg: '#FFE4C4', blush: '#FFB6C1' },
            { bg: '#FCD5CE', blush: '#F08080' }, { bg: '#F8C8B5', blush: '#E9967A' },
            { bg: '#EAC0A6', blush: '#CD853F' }, { bg: '#D2B48C', blush: '#A0522D' },
            { bg: '#C68E63', blush: '#8B4513' }, { bg: '#A67B5B', blush: '#6B4226' },
            { bg: '#8D5524', blush: '#5C3317' }, { bg: '#4B3621', blush: '#301F12' }
        ];

        window.initPimpleGame = function() {
            let html = `
                <p style="margin-bottom:15px;font-weight:700;text-align:center;">é€£é»ç—˜ç—˜æŠŠå®ƒå€‘å…¨éƒ¨æ“ çˆ†ï¼</p>
                <div class="head-wrapper">
                    <div class="ear left" id="ear-l"></div>
                    <div class="ear right" id="ear-r"></div>
                    <div class="face-container" id="face-area">
                        <div class="face-eyes"><div class="eye"></div><div class="eye"></div></div>
                        <div class="face-blush" id="face-blush"><div class="blush"></div><div class="blush"></div></div>
                        <div class="face-nose" id="face-nose"></div>
                        <div class="face-mouth"></div>
                    </div>
                </div>
                <button onclick="initPimpleGame()" style="margin-top:10px;padding:10px 20px;border-radius:15px;border:none;background:var(--primary);color:white;font-weight:700;cursor:pointer;">ğŸ”„ æ›å¼µè‡‰</button>
            `;
            gameContent.innerHTML = html;

            const face = document.getElementById('face-area');
            const earL = document.getElementById('ear-l');
            const earR = document.getElementById('ear-r');
            const faceNose = document.getElementById('face-nose');
            const blushLeft = document.getElementById('face-blush').children[0];
            const blushRight = document.getElementById('face-blush').children[1];
            
            const config = faceConfigs[Math.floor(Math.random() * faceConfigs.length)];
            face.style.background = config.bg;
            earL.style.background = config.bg;
            earR.style.background = config.bg;
            faceNose.style.background = config.bg;
            blushLeft.style.background = config.blush;
            blushRight.style.background = config.blush;

            const pimpleCount = Math.floor(Math.random() * 3) + 6; 
            let poppedTotal = 0;

            for(let i=0; i<pimpleCount; i++) {
                let p = document.createElement('div');
                let size = Math.random() * 20 + 20;
                p.className = 'pimple';
                p.style.width = size + 'px'; p.style.height = size + 'px';
                
                let leftPos = Math.random() * 70 + 15;
                let topPos = Math.random() * 80 + 10;
                if(leftPos > 25 && leftPos < 75 && topPos > 35 && topPos < 70) {
                    topPos = topPos > 52 ? 75 : 15; 
                }
                p.style.left = leftPos + '%'; p.style.top = topPos + '%';
                
                let redHue = Math.random() > 0.5 ? '#FF8C8C' : '#FF4040';
                p.style.background = `radial-gradient(circle at 30% 30%, ${redHue}, #B22222)`;
                p.style.boxShadow = `-3px 4px 8px rgba(0,0,0,0.2), inset 3px 3px 6px rgba(255,255,255,0.4)`;
                
                let core = document.createElement('div');
                core.className = 'pimple-core';
                p.appendChild(core);
                face.appendChild(p);

                let clicksNeeded = Math.floor(Math.random() * 11) + 10;
                let currentClicks = 0;

                p.addEventListener('touchstart', function(e) { e.preventDefault(); handlePimpleClick(); }, {passive: false});
                p.addEventListener('mousedown', function(e) { e.preventDefault(); handlePimpleClick(); });

                function handlePimpleClick() {
                    if(currentClicks >= clicksNeeded) return;
                    currentClicks++;
                    p.style.transform = `scale(${1 + currentClicks * 0.05})`;
                    
                    if(currentClicks === clicksNeeded) {
                        playSound('pimple');
                        p.style.display = 'none'; 
                        poppedTotal++;
                        if(poppedTotal === pimpleCount) {
                            setTimeout(() => alert('âœ¨æ¶ˆæ»…ç—˜ç—˜ï¼è‡‰è›‹è®Šå¹³æ»‘äº†ï¼'), 400);
                        }
                    }
                }
            }
        }
    </script>
</body>
</html>
